<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Catálogo de Productos</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container productos-admin">
    <h1>Catálogo de Productos</h1>
    <div style="text-align:center; margin-bottom:24px;">
      <a href="menu.html" class="volver-menu">&#8592; Volver al menú</a>
    </div>
    <div class="productos-actions">
      <button id="btn-refrescar" class="btn-small" style="width:auto;">Refrescar lista</button>
      <button id="btn-toggle-nuevo" class="btn-small" style="width:auto;">Agregar nuevo</button>
    </div>
    <div id="nuevo-form" style="display:none;" class="nuevo-form">
      <h3>Nuevo Producto</h3>
      <div class="inline" style="gap:8px; flex-wrap:wrap;">
        <input type="text" id="p-codigo" placeholder="Código" />
        <input type="text" id="p-desc" placeholder="Descripción" />
        <select id="p-unidad">
          <option value="PAQ">PAQ</option>
          <option value="UND">UND</option>
        </select>
        <button type="button" id="p-guardar" class="btn-small">Guardar</button>
      </div>
      <small id="p-msg"></small>
    </div>
    <div class="tabla-wrapper">
      <table id="tabla-productos" class="tabla-productos">
        <thead>
          <tr><th>Código</th><th>Descripción</th><th>Unidad</th><th>Acciones</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="estado-carga" class="estado-carga"></div>
  </div>
  <script>
  (function(){
      const ADMIN_KEY = 'PASANTIAS90'; // misma clave cliente (protege el endpoint para agregar)
  const URL_BASE = (localStorage.getItem('WEB_APP_URL_DYNAMIC')||'').trim() || "https://script.google.com/macros/s/AKfycbzNw7ko-872o3NPxXxN8pnsEoviYdG2JhWJNh5tK1k4KTHv-1m8qDUm9pjgQVGfEJyACg/exec";
      let cache = [];
      const cuerpo = document.querySelector('#tabla-productos tbody');
      const estado = document.getElementById('estado-carga');
  function endpointProductos(){ return URL_BASE + (URL_BASE.includes('?')?'&':'?') + 'action=productos'; }
  function endpointAdd(){ return URL_BASE + (URL_BASE.includes('?')?'&':'?') + 'action=addProduct'; }
  function endpointDelete(){ return URL_BASE + (URL_BASE.includes('?')?'&':'?') + 'action=deleteProduct'; }
      async function cargar(){
        estado.textContent = 'Cargando...';
        try {
          const r = await fetch(endpointProductos(), {method:'GET', cache:'no-store'});
          const t = await r.text();
          let j; try{ j = JSON.parse(t); }catch(e){ j = {}; }
          cache = Array.isArray(j.products) ? j.products : [];
          render();
          estado.textContent = cache.length + ' productos';
        } catch(e){ estado.textContent = 'Error al cargar'; cuerpo.innerHTML=''; }
      }
      function render(){
        cuerpo.innerHTML = '';
        cache.forEach(p => {
           const tr = document.createElement('tr');
           tr.innerHTML = `<td>${p.codigo}</td><td>${p.descripcion||p.desc||''}</td><td>${p.unidad}</td>
                           <td><button class="btn-small danger" data-cod="${p.codigo}">Eliminar</button></td>`;
           const btn = tr.querySelector('button[data-cod]');
           btn.addEventListener('click', ()=> eliminar(p.codigo));
           cuerpo.appendChild(tr);
        });
      }
      async function eliminar(codigo){
        if(!codigo) return;
        const ok = confirm(`¿Eliminar el producto "${codigo}" del catálogo?`);
        if(!ok) return;
        estado.textContent = 'Eliminando...';
        const fd = new FormData();
        fd.append('codigo', codigo);
        fd.append('adminKey', ADMIN_KEY);
        try{
          const r = await fetch(endpointDelete(), {method:'POST', body: fd});
          const t = await r.text(); let j; try{ j = JSON.parse(t);}catch(_){ j={ok:r.ok}; }
          if(j.ok){ await cargar(); estado.textContent = 'Producto eliminado'; setTimeout(()=>estado.textContent= cache.length + ' productos', 1000); }
          else { estado.textContent = 'No se pudo eliminar (verifica código/clave)'; }
        }catch(e){ estado.textContent = 'Error de conexión'; }
      }
      async function guardar(){
        const codigo = document.getElementById('p-codigo').value.trim();
        const desc = document.getElementById('p-desc').value.trim();
        const unidad = document.getElementById('p-unidad').value;
        const msg = document.getElementById('p-msg');
        if(!codigo || !desc){ msg.textContent='Completa código y descripción'; msg.style.color='#ff7675'; return; }
        if(cache.some(p=> (p.codigo||'').toLowerCase() === codigo.toLowerCase())){ msg.textContent='Ese código ya existe'; msg.style.color='#ffb347'; return; }
        msg.textContent='Guardando...'; msg.style.color='#bfc8e2';
        const fd = new FormData();
        fd.append('codigo', codigo);
        fd.append('descripcion', desc);
        fd.append('unidad', unidad);
        fd.append('adminKey', ADMIN_KEY);
        try {
          const r = await fetch(endpointAdd(), {method:'POST', body: fd});
          const t = await r.text(); let j; try{ j=JSON.parse(t);}catch(_){ j={ok:r.ok}; }
          if(j.ok){ msg.textContent='Guardado'; msg.style.color='#43e6b1'; cache=[]; await cargar(); document.getElementById('p-codigo').value=''; document.getElementById('p-desc').value=''; }
          else { msg.textContent='Error al guardar'; msg.style.color='#ff7675'; }
        } catch(e){ msg.textContent='Error de conexión'; msg.style.color='#ff7675'; }
      }
      document.getElementById('btn-refrescar').addEventListener('click', cargar);
      document.getElementById('btn-toggle-nuevo').addEventListener('click', ()=>{
        const box = document.getElementById('nuevo-form');
        box.style.display = box.style.display==='none' ? 'block' : 'none';
      });
      document.getElementById('p-guardar').addEventListener('click', guardar);
      cargar();
  })();
  </script>
</body>
</html>
