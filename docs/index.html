<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Formularios Empaquetado y Merma</title>
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
    <div class="container">
        <h1>Registro de Formularios</h1>
        <div style="text-align:center; margin-bottom:20px;">
            <a href="menu.html" class="volver-menu">&#8592; Volver al menú</a>
        </div>
        <div class="form-section" id="form-empaquetados" style="display:none;">
            <h2>EMPAQUETADOS</h2>
            <form id="empaquetados-form">
                <div class="compact-grid">
                    <div class="field">
                        <label for="empa-fecha">Fecha:</label>
                        <div class="inline">
                            <input type="date" id="empa-fecha" name="fecha" required />
                            <button type="button" id="empa-btn-fecha-hoy" class="btn-small">Hoy</button>
                        </div>
                        <input type="text" id="empa-hora" name="hora" placeholder="Hora" readonly class="hora-input" />
                    </div>
                    <div class="field">
                        <label for="empa-entregado">Entregado a:</label>
                        <select id="empa-entregado" name="entregado" required class="select">
                            <option value="">Selecciona una opción</option>
                            <option>K FOOD</option>
                            <option>DESPACHO</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="empa-registro">Número de registro:</label>
                        <input type="text" id="empa-registro" name="registro" required />
                    </div>
                    <div class="field">
                        <label for="empa-responsable">Responsable:</label>
                        <select id="empa-responsable" name="responsable" required class="select">
                            <option value="">Selecciona un responsable</option>
                            <option>Alexander Guevara</option>
                            <option>Yefrin Arteaga</option>
                            <option>Leandro Gil</option>
                            <option>Jesus Alcedo</option>
                            <option>Eliezer N</option>
                            <option>Odalis</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="empa-sede">Sede:</label>
                        <select id="empa-sede" name="sede" required class="select">
                            <option value="">Selecciona una sede</option>
                            <option>PANIFICADORA COSTA DORADA, C.A.</option>
                            <option>ALIMENTOS PB2, C.A.</option>
                        </select>
                    </div>
                </div>
                <div class="productos-section">
                    <label>Productos y cantidades:</label>
                    <div id="empa-productos-seleccionados" class="seleccionados"></div>
                    <div class="agregar-wrapper">
                        <button type="button" id="empa-btn-agregar-producto" class="btn-small secondary">Agregar producto</button>
                        <div id="empa-panel-productos" class="panel-productos" style="display:none;">
                            <input type="text" id="empa-panel-buscar" placeholder="Buscar producto o código" />
                            <div id="empa-panel-lista" class="panel-lista"></div>
                        </div>
                    </div>
                    <div class="add-catalogo-wrapper" style="margin-top:8px;">
                        <button type="button" id="toggle-nuevo-prod" class="btn-small">Agregar al catálogo</button>
                        <div id="nuevo-prod-box" style="display:none; margin-top:6px;" class="panel-productos">
                            <div class="inline" style="gap:8px; flex-wrap:wrap;">
                                <input type="text" id="np-codigo" placeholder="Código" />
                                <input type="text" id="np-desc" placeholder="Descripción" />
                                <input type="text" id="np-unidad" placeholder="Unidad (PAQ/UND)" />
                                <button type="button" id="np-guardar" class="btn-small">Guardar</button>
                            </div>
                            <small id="np-msg" style="color:#bfc8e2"></small>
                        </div>
                    </div>
                </div>
                <div class="form-actions" style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
                    <button type="submit">Enviar</button>
                    <button type="button" class="secondary" onclick="clearForm('empaquetados-form')">Limpiar</button>
                </div>
            </form>
        </div>
        <div class="form-section" id="form-merma" style="display:none;">
            <h2>MERMA</h2>
            <form id="merma-form">
                <div class="compact-grid">
                    <div class="field">
                        <label for="merma-fecha">Fecha:</label>
                        <div class="inline">
                            <input type="date" id="merma-fecha" name="fecha" required />
                            <button type="button" id="merma-btn-fecha-hoy" class="btn-small">Hoy</button>
                        </div>
                        <input type="text" id="merma-hora" name="hora" placeholder="Hora" readonly class="hora-input" />
                    </div>
                    <div class="field">
                        <label for="merma-motivo">Motivo:</label>
                        <select id="merma-motivo" name="motivo" required class="select">
                            <option value="">Selecciona una opción</option>
                            <option>QUEMADOS</option>
                            <option>DEFORMES</option>
                            <option>DESMOLDADO</option>
                            <option>SOBRANTE BUEN ESTADO</option>
                            <option>PEQUEÑOS  EN TAMAÑO</option>
                            <option>VIRUTA</option>
                            <option>SOBREPASA EL TAMAÑO ADECUADO</option>
                            <option>ADHERIDO AL MOLDE</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="merma-sede">Sede:</label>
                        <select id="merma-sede" name="sede" required class="select">
                            <option value="">Selecciona una sede</option>
                            <option>PANIFICADORA COSTA DORADA, C.A.</option>
                            <option>ALIMENTOS PB2, C.A.</option>
                        </select>
                    </div>
                </div>
                <div class="productos-section">
                    <label>Productos y cantidades:</label>
                    <div id="merma-productos-seleccionados" class="seleccionados"></div>
                    <div class="agregar-wrapper">
                        <button type="button" id="merma-btn-agregar-producto" class="btn-small secondary">Agregar producto</button>
                        <div id="merma-panel-productos" class="panel-productos" style="display:none;">
                            <input type="text" id="merma-panel-buscar" placeholder="Buscar producto o código" />
                            <div id="merma-panel-lista" class="panel-lista"></div>
                        </div>
                    </div>
                </div>
                <div class="form-actions" style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
                    <button type="submit">Enviar</button>
                    <button type="button" class="secondary" onclick="clearForm('merma-form')">Limpiar</button>
                </div>
            </form>
        </div>
        <div id="mensaje"></div>
    </div>
    <script src="script.js"></script>
    <script>
    (function(){
        let PRODUCTOS_CACHE = [];
        function getBaseUrl(){
            return (localStorage.getItem('WEB_APP_URL_DYNAMIC')||'').trim() || "https://script.google.com/macros/s/AKfycbzNw7ko-872o3NPxXxN8pnsEoviYdG2JhWJNh5tK1k4KTHv-1m8qDUm9pjgQVGfEJyACg/exec";
        }
        async function cargarProductos(){
            if(PRODUCTOS_CACHE.length) return PRODUCTOS_CACHE;
            const base = getBaseUrl();
            const url = base + (base.includes('?')?'&':'?') + 'action=productos';
            try {
                const r = await fetch(url, {method:'GET', cache:'no-store'});
                const text = await r.text();
                const j = JSON.parse(text);
                PRODUCTOS_CACHE = Array.isArray(j.products) ? j.products.map(p=>({codigo:p.codigo, desc:p.descripcion, unidad:p.unidad})) : [];
            } catch(e){ PRODUCTOS_CACHE = []; }
            return PRODUCTOS_CACHE;
        }
        function initFecha(prefix){
            const btn = document.getElementById(prefix+'-btn-fecha-hoy');
            const fecha = document.getElementById(prefix+'-fecha');
            const hora = document.getElementById(prefix+'-hora');
            if(!btn) return;
            btn.addEventListener('click', ()=>{
                const now = new Date();
                const vz = new Date(now.toLocaleString('en-US',{timeZone:'America/Caracas'}));
                const yyyy = vz.getFullYear();
                const mm = String(vz.getMonth()+1).padStart(2,'0');
                const dd = String(vz.getDate()).padStart(2,'0');
                fecha.value = `${yyyy}-${mm}-${dd}`;
                const hh = String(vz.getHours()).padStart(2,'0');
                const min = String(vz.getMinutes()).padStart(2,'0');
                hora.value = `${hh}:${min}`;
            });
        }
        function initPanel(prefix){
            const panel = document.getElementById(prefix+'-panel-productos');
            const buscar = document.getElementById(prefix+'-panel-buscar');
            const lista = document.getElementById(prefix+'-panel-lista');
            const btn = document.getElementById(prefix+'-btn-agregar-producto');
            const contSel = document.getElementById(prefix+'-productos-seleccionados');
            if(!panel||!buscar||!lista||!btn||!contSel) return;
            function render(term=''){
                const t = term.trim().toLowerCase();
                lista.innerHTML='';
                const datos = t? PRODUCTOS_CACHE.filter(p=>p.codigo.toLowerCase().includes(t)||p.desc.toLowerCase().includes(t)) : PRODUCTOS_CACHE;
                datos.forEach(p=>{
                    const div = document.createElement('div');
                    div.className='panel-item';
                    div.innerHTML = `<strong>${p.codigo}</strong> — ${p.desc}`;
                    div.addEventListener('click',()=>addProducto(p));
                    lista.appendChild(div);
                });
            }
            function open(){ panel.style.display='block'; buscar.value=''; render(''); buscar.focus(); }
            function close(){ panel.style.display='none'; }
            btn.addEventListener('click', ()=>{ panel.style.display==='none'?open():close(); });
            document.addEventListener('click', e=>{ if(!panel.contains(e.target) && e.target!==btn) close(); });
            document.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });
            buscar.addEventListener('input', ()=>render(buscar.value));
            function addProducto(p){
                const ya = contSel.querySelector(`.sel-row[data-codigo="${p.codigo}"] input.prod-qty`);
                if(ya){ ya.focus(); close(); return; }
                const row = document.createElement('div');
                row.className='sel-row producto-line';
                row.dataset.codigo = p.codigo;
                row.innerHTML = `
                    <div class="prod-name"><strong>${p.codigo}</strong> — ${p.desc}</div>
                    <div class="qty-actions">
                        <input type="number" min="1" step="1" class="prod-qty" placeholder="0"
                            data-codigo="${p.codigo}"
                            data-desc="${(p.desc||'').replace(/"/g,'&quot;')}"
                            data-unidad="${p.unidad}" name="qty_${p.codigo}">
                        <button type="button" class="remove-sel">✕</button>
                    </div>`;
                row.querySelector('.remove-sel').addEventListener('click', ()=>row.remove());
                contSel.appendChild(row);
                row.querySelector('.prod-qty').focus();
                close();
            }
            return { render, open, close, buscar };
        }
        async function refreshPanels(){
            await cargarProductos();
            if(window.__empaPanel) window.__empaPanel.render(window.__empaPanel.buscar.value);
            if(window.__mermaPanel) window.__mermaPanel.render(window.__mermaPanel.buscar.value);
        }
        async function guardarNuevoProducto(){
            const codigo = document.getElementById('np-codigo').value.trim();
            const desc = document.getElementById('np-desc').value.trim();
            const unidad = (document.getElementById('np-unidad').value.trim()||'PAQ');
            const msg = document.getElementById('np-msg');
            if(!codigo || !desc){ msg.textContent='Completa código y descripción'; return; }
            if(PRODUCTOS_CACHE.some(p=>p.codigo.toLowerCase()===codigo.toLowerCase())){ msg.textContent='Código ya existe'; return; }
            const base = getBaseUrl();
            const url = base + (base.includes('?')?'&':'?') + 'action=addProduct';
            const fd = new FormData();
            fd.append('codigo', codigo);
            fd.append('descripcion', desc);
            fd.append('unidad', unidad);
            fd.append('adminKey', 'PASANTIAS90');
            msg.textContent='Guardando...';
            try {
                const r = await fetch(url, {method:'POST', body: fd});
                const t = await r.text(); let j; try{ j=JSON.parse(t);}catch(_){ j={ok:r.ok}; }
                if(j.ok){
                    msg.textContent='Guardado'; PRODUCTOS_CACHE=[]; await refreshPanels();
                    setTimeout(()=>{ msg.textContent=''; document.getElementById('np-codigo').value=''; document.getElementById('np-desc').value=''; },1200);
                } else msg.textContent='Error al guardar';
            } catch(e){ msg.textContent='Error de conexión'; }
        }
        document.addEventListener('DOMContentLoaded', async ()=>{
            const abrirTab = localStorage.getItem('abrirTab');
            const empaDiv = document.getElementById('form-empaquetados');
            const mermaDiv = document.getElementById('form-merma');
            if(abrirTab==='empaquetados') empaDiv.style.display='';
            else if(abrirTab==='merma') mermaDiv.style.display='';
            else empaDiv.style.display='';
            localStorage.removeItem('abrirTab');
            initFecha('empa');
            initFecha('merma');
            window.__empaPanel = initPanel('empa');
            window.__mermaPanel = initPanel('merma');
            await refreshPanels();
            const toggleNuevo = document.getElementById('toggle-nuevo-prod');
            const boxNuevo = document.getElementById('nuevo-prod-box');
            if(toggleNuevo) toggleNuevo.addEventListener('click', ()=>{ boxNuevo.style.display = boxNuevo.style.display==='none' ? 'block':'none'; });
            const guardarBtn = document.getElementById('np-guardar');
            if(guardarBtn) guardarBtn.addEventListener('click', guardarNuevoProducto);
        });
    })();
    </script>
</body>
</html>
                        item.innerHTML = `<strong>${p.codigo}</strong> — ${p.desc}`;
                        item.addEventListener('click', ()=>addProducto(p));
                        panelLista.appendChild(item);
                    });
                }
                panelBuscar.addEventListener('input', ()=>renderPanel(panelBuscar.value));
                function openPanel(){ panel.style.display='block'; panelBuscar.value=''; refreshProductsAndRender(''); panelBuscar.focus(); }
                function closePanel(){ panel.style.display='none'; }
                btnAgregar.addEventListener('click', ()=>{ panel.style.display!=='none'?closePanel():openPanel(); });
                document.addEventListener('click', (e)=>{ if(!panel.contains(e.target) && e.target!==btnAgregar) closePanel(); });
                document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closePanel(); });
                function addProducto(p) {
                    const existente = seleccionados.querySelector(`.sel-row[data-codigo="${p.codigo}"] input.prod-qty`);
                    if (existente) { existente.focus(); closePanel(); return; }
                    const row = document.createElement('div');
                    row.className='sel-row producto-line';
                    row.dataset.codigo = p.codigo;
                    row.innerHTML = `
                        <div class="prod-name"><strong>${p.codigo}</strong> — ${p.desc}</div>
                        <div class="qty-actions">
                            <input type="number" min="1" step="1" class="prod-qty" placeholder="0" data-codigo="${p.codigo}" data-desc="${p.desc.replace(/"/g, '&quot;')}" data-unidad="${p.unidad}" name="qty_${p.codigo}">
                            <button type="button" class="remove-sel">✕</button>
                        </div>`;
                    row.querySelector('.remove-sel').addEventListener('click', ()=>row.remove());
                    seleccionados.appendChild(row);
                    row.querySelector('.prod-qty').focus();
                    closePanel();
                }
            });
            </script>
        </div>
        <div id="mensaje"></div>
    </div>
    <script src="script.js"></script>
    <script>
    // Mostrar solo el formulario seleccionado al entrar desde el menú
    window.onload = function() {
        const empaDiv = document.getElementById('form-empaquetados');
        const mermaDiv = document.getElementById('form-merma');
        empaDiv.style.display = 'none';
        mermaDiv.style.display = 'none';
        const abrirTab = localStorage.getItem('abrirTab');
        if (abrirTab === 'empaquetados') {
            empaDiv.style.display = '';
        } else if (abrirTab === 'merma') {
            mermaDiv.style.display = '';
        }
        localStorage.removeItem('abrirTab');
    }
    </script>
</body>
</html>